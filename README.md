# VisionLens AR 🌟

基于 MediaPipe 的实时虚拟试戴系统

## 项目核心优势

- **零配置门槛**：无需配置复杂的 CUDA 环境或寻找昂贵的 GPU，纯 CPU 即可跑出 30+ FPS
- **极致精度**：MediaPipe 提供 468 个 3D 关键点（甚至包含眼球追踪），远超自行训练的 15 点或 98 点模型
- **开发重心**：你可以将精力从"调参"转移到"交互逻辑"和"视觉特效设计"上

## 核心功能模块

### 1. 毫秒级人脸拓扑映射系统

启动后，会迅速在人脸上覆盖一层隐形的"数字网格"。这 468 个点不仅包含五官，还包含脸颊、额头以及精准的嘴唇内廓，为饰品挂载提供坐标参考。

### 2. 智能饰品对齐算法

利用 3D 坐标点计算头部的姿态（Pitch, Yaw, Roll）：
- **自动缩放**：眼镜大小随人脸前后的空间深度自动调节
- **透视变换**：当你侧脸时，眼镜素材会进行非线性形变，模拟真实的透视效果，而不仅仅是简单的图片旋转

### 3. 动态触发式特效

使用按键切换特效：
- **按键切换**：按 'g' 键切换眼镜样式，按 'b' 键切换胡子样式

### 4. 高级图像融合

使用 Alpha 混合技术，确保虚拟物体与真实皮肤边缘过渡自然。支持多挂件同时加载（如同时佩戴眼镜和胡子）。

## 环境要求

- Python 3.8+
- 摄像头设备

## 安装步骤

1. 克隆或下载项目到本地

2. 安装依赖包：
```bash
pip install -r requirements.txt
```

3. **模型文件**（首次运行会自动下载）：
   - 程序首次运行时会自动从 MediaPipe 官方资源下载 `face_landmarker.task` 模型文件
   - 模型文件会保存在 `./models/` 目录下
   - 如果自动下载失败，可以手动下载：
     - 访问：https://developers.google.com/mediapipe/solutions/vision/face_landmarker
     - 下载 `face_landmarker.task` 文件
     - 保存到 `./models/` 目录

4. 准备资源文件：
   - 在 `./assets/glasses/` 目录下放置眼镜的 PNG 图片（支持透明背景）
   - 在 `./assets/beard/` 目录下放置胡子的 PNG 图片（支持透明背景）

## 使用方法

1. 运行主程序：
```bash
python main.py
```

2. 按键操作：
   - **'g'** - 切换眼镜样式（循环切换，再次按可关闭）
   - **'b'** - 切换胡子样式（循环切换，再次按可关闭）
   - **'q'** - 退出程序

3. 程序窗口会显示：
   - 实时 FPS
   - 当前激活的饰品状态

## 项目结构

```
visionlens_final/
├── main.py                 # 主程序入口
├── visionlens/
│   ├── __init__.py
│   ├── face_detector.py    # MediaPipe 人脸检测与关键点提取
│   ├── accessory_manager.py # 饰品管理器（加载、切换、渲染）
│   ├── transform_utils.py   # 3D 变换工具（缩放、透视、对齐）
│   ├── effects.py          # 特效处理（Alpha 混合、多挂件融合）
│   └── model_downloader.py  # 模型文件下载工具
├── models/                 # 模型文件目录（自动创建）
│   └── face_landmarker.task # MediaPipe 模型文件（自动下载）
├── assets/                 # 资源目录
│   ├── glasses/           # 眼镜 PNG 文件
│   └── beard/             # 胡子 PNG 文件
├── requirements.txt        # 依赖包
└── README.md              # 项目说明
```

## 技术实现

### 关键点索引映射

- 左眼中心：索引 159（上方）
- 右眼中心：索引 386（上方）
- 鼻梁中心：索引 6
- 下巴：索引 175（用于胡子定位）

### 3D 变换算法

1. **缩放计算**：基于两眼间距离和鼻梁到下巴的距离
2. **旋转计算**：使用关键点计算头部姿态角（Pitch, Yaw, Roll）
3. **透视变换**：根据 Yaw 角度调整饰品的形变程度

### 渲染流程

```
摄像头帧 → MediaPipe 检测 → 提取关键点 → 计算变换矩阵 → 
加载饰品 PNG → 应用变换 → Alpha 混合 → 输出到窗口
```

## 资源文件准备

### 眼镜图片要求

- 格式：PNG（支持透明背景）
- 建议尺寸：宽度 200-400 像素
- 位置：眼镜中心应该位于图片中心
- 透明背景：确保眼镜外的区域是透明的

### 胡子图片要求

- 格式：PNG（支持透明背景）
- 建议尺寸：宽度 150-300 像素
- 位置：胡子中心应该位于图片中心
- 透明背景：确保胡子外的区域是透明的

## 常见问题

### Q: 程序无法启动摄像头？
A: 请检查摄像头是否被其他程序占用，或者尝试更改摄像头索引（在 main.py 中修改 `cv2.VideoCapture(0)` 为其他数字）。

### Q: 模型文件下载失败？
A: 如果自动下载失败，请：
   - 检查网络连接
   - 使用代理或 VPN（如果需要）
   - 手动下载模型文件：访问 https://developers.google.com/mediapipe/solutions/vision/face_landmarker，下载 `face_landmarker.task` 并保存到 `./models/` 目录

### Q: 饰品位置不准确？
A: 确保资源图片的中心点正确，眼镜的中心应该在两眼之间，胡子的中心应该在嘴唇下方。

### Q: 性能不够流畅？
A: 可以降低摄像头分辨率（在 main.py 中修改 `cap.set` 的参数），或者减少资源图片的尺寸。

## 开发说明

本项目使用 MediaPipe Face Mesh 进行人脸检测，无需 GPU 即可运行。所有核心功能都在 `visionlens` 模块中实现，便于扩展和维护。

## 许可证

本项目仅供学习和研究使用。

## 贡献

欢迎提交 Issue 和 Pull Request！

